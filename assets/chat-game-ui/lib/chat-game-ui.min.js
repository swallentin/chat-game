// chat-game-ui, v0.2.0
// Copyright (c)2012 Stephan Wallentin, EF Labs
// http://github.com/englishtown/chat-game
var Game=Backbone.Model.extend({idAttribute:"_id",urlRoot:"/games"}),Question=Backbone.Model.extend({}),Player=Backbone.Model.extend({urlRoot:"/users"}),Games=Backbone.Collection.extend({url:"/games",model:Game}),Players=Backbone.Collection.extend({model:Player}),Questions=Backbone.Collection.extend({model:Question,url:function(){return function(){return console.log(this.urlRoot+this.get("id")),this.urlRoot+this.get("id")}},parse:function(e){return e.alternatives}}),AppRouter=Backbone.Router.extend({vent:_.extend({},Backbone.Events),routes:{"game/:id":"game","":"index"},index:function(){var e=new Games;e.fetch({success:function(){var t=new GameListView({collection:e});$("#game").html(t.render().el)}})},game:function(e){var t=this,n=new Game({_id:e});n.fetch({success:function(e,n){var r=new GameView({el:$("#game"),vent:t.vent,model:e});$("#game").html(r.render().el)}})}}),ChooseQuestionListView=Backbone.View.extend({initialize:function(e){this.vent=e.vent||{},this.clickQuestionEventName=e.clickQuestionEventName||"clickedQuestion",_.bindAll(this)},render:function(){var e=new Questions({}),t=this;return e.fetch({url:"/paragraphs/"+t.model.get("currentParagraph")._id,success:function(){e.each(t.addQuestion)}}),this},addQuestion:function(e){var t=(new ChooseQuestionView({model:e,vent:this.vent,clickQuestionEventName:this.clickQuestionEventName})).bind("clickedQuestion",this.onClickQuestion);$(this.el).append(t.render().el)},onClickQuestion:function(e){console.log("ChooseQuestionListView:onClickQuestion"),this.trigger("clickedQuestion",e)}}),ChooseQuestionView=Backbone.View.extend({tagName:"button",className:"btn btn-large btn-primary choose-answer",type:"button",events:{click:"onClickedQuestion"},initialize:function(e){this.vent=e.vent||{},_.bindAll(this),this.model.get("difficulty")&&(this.ratingView=new RatingView({level:this.model.get("difficulty"),vent:this.vent}))},render:function(){return $(this.el).html(this.model.get("text")),this.model.get("difficulty")&&$(this.el).append(this.ratingView.render().el),this},onClickedQuestion:function(){var e={view:this,model:this.model};this.trigger("clickedQuestion",e)}}),RatingView=Backbone.View.extend({className:"rating-container",initialize:function(e){this.level=e.level||0},render:function(){var e=0;for(;e<this.level;e++)$(this.el).append('<i class="icon-star icon-yellow"></i>');return this}}),SimpleAudioPlayerView=Backbone.View.extend({className:"well player",events:{"click .btn-play":"play","click .btn-stop":"stop"},initialize:function(){_.bindAll(this),this.template=Handlebars.compile($("#SimpleAudioPlayerView-template").html()),this.on("setupAudio",this.onSetupAudio),this.on("play",this.onPlay),this.on("stop",this.onStop)},render:function(){return this.setupAudio(),this},renderAudioController:function(){console.log("SimpleAudioPlayer:renderAudioController"),$(this.el).html(this.template())},setupAudio:function(){console.log("SimpleAudioPlayer:setupAudio"),this.trigger("setupAudio")},play:function(){console.log("play"),this.trigger("play")},stop:function(){console.log("stop"),this.trigger("stop")},onPlay:function(){console.log("SimpleAudioPlayer:onPlay"),Wami.startPlaying(this.model.get("url"))},onStop:function(){console.log("SimpleAudioPlayer:onStop"),Wami.stopPlaying()},onSetupAudio:function(){console.log("SimpleAudioPlayer:onSetupAudio"),$(this.el).html("Setting up audio control.");var e=this.onSetupAudioFinished;Wami.setup({id:"wami",onLoaded:this.onSetupAudioFinished})},onSetupAudioFinished:function(){console.log("SimpleAudioPlayer:onSetupAudioFinished"),this.renderAudioController()}}),SimpleAudioRecorderView=Backbone.View.extend({className:"recorder well",events:{"click .btn-record":"record","click .btn-stoprecord":"stop"},initialize:function(){_.bindAll(this),this.template=Handlebars.compile($("#SimpleAudioRecorderView-template").html()),this.on("setupAudio",this.onSetupAudio),this.on("record",this.onRecord),this.on("stop",this.onStop)},render:function(){return this.setupAudio(),this},renderAudioController:function(){console.log("SimpleAudioRecorderView:renderAudioController"),$(this.el).html(this.template())},setupAudio:function(){console.log("SimpleAudioRecorderView:setupAudio"),this.trigger("setupAudio")},record:function(){console.log("SimpleAudioRecorderView:record"),this.trigger("record")},stop:function(){console.log("stop"),this.trigger("stop")},onRecord:function(){console.log("SimpleAudioRecorderView:onPlay"),Wami.startRecording(this.model.get("recordingUrl"))},onStop:function(){console.log("SimpleAudioRecorderView:onStop"),Wami.stopRecording()},onSetupAudio:function(){console.log("SimpleAudioRecorderView:onSetupAudio"),$(this.el).html("Setting up audio control.");var e=this.onSetupAudioFinished;Wami.setup({id:"wami",onLoaded:this.onSetupAudioFinished})},onSetupAudioFinished:function(){console.log("SimpleAudioRecorderView:onSetupAudioFinished"),this.renderAudioController()}}),GameView=Backbone.View.extend({initialize:function(e){this.vent=e.vent||{},this.playingView=new GamePlayingView({vent:this.vent,model:this.model})},render:function(){return this.playingView.render()}}),GameListItemView=Backbone.View.extend({tagName:"LI",className:"item game-list-item",initialize:function(){this.template=Handlebars.compile($("#GameListItemView-template").html())},render:function(){var e=this.template(this.model.toJSON());return $(this.el).html(e),this}}),GameListView=Backbone.View.extend({className:"game-list",tagName:"UL",initialize:function(e){this.vent=e.vent||{},_.bindAll(this)},render:function(){return this.collection.each(this.addItem),this},addItem:function(e){var t=new GameListItemView({model:e}),n=t.render().el;$(this.el).append(n)}}),GameNotPlayingView=Backbone.View.extend({initialize:function(e){this.vent=e.vent||{}}}),StartGameView=Backbone.View.extend({initialize:function(e){this.vent=e.vent||{}}}),GameActionView=Backbone.View.extend({tagName:"div",className:"action quotes",initialize:function(e){this.vent=e.vent||{},this.template=Handlebars.compile(e.template||""),_.bindAll(this),this.on("load",this.onLoad),this.vent.on("/game/#:id/listening",this.renderListening),this.vent.on("/game/#:id/speaking",this.renderSpeaking)},onLoad:function(){},render:function(){return $(this.el).html(this.template(this.model.toJSON())),this},renderActiveView:function(){$(this.el).find("#content").html(this.activeView.render().el)},renderListening:function(){console.log("GameActionView:renderListening"),this.activeView=(new PlayingListeningView({vent:this.vent,model:this.model})).bind("next",this.onFinishedListening),this.renderActiveView()},renderSpeaking:function(){console.log("GameActionView:renderSpeaking"),this.activeView=(new PlayingSpeakingView({vent:this.vent,model:this.model})).bind("next",this.onFinishedSpeaking),this.renderActiveView()},onFinishedListening:function(){this.vent.trigger("/game/#:id/speaking")},onFinishedSpeaking:function(){this.vent.trigger("/game/#:id/listening")}}),GameOverView=Backbone.View.extend({className:"game-over",initialize:function(e){this.vent=e.vent||{}}}),GamePlayingView=Backbone.View.extend({className:"playing",tagName:"div",initialize:function(e){this.vent=e.vent||{};var t=this;this.statusView=new GameStatusView({vent:this.vent,model:t.model,template:$("#GameStatusView-template").html()}),this.actionView=new GameActionView({vent:this.vent,template:$("#GameActionView-template").html(),model:t.model})},render:function(){return $(this.el).append(this.statusView.render().el),$(this.el).append(this.actionView.render().el),this.vent.trigger("/game/#:id/speaking"),this}}),GameStatusView=Backbone.View.extend({className:"game-state-info btn-inverse",initialize:function(e){this.template=Handlebars.compile(e.template||"")},render:function(){return $(this.el).html(this.template(this.model.toJSON())),this}}),AnswerView=Backbone.View.extend({events:{"click .btn-next":"onClickedNext"},initialize:function(e){this.message=e.message||"No message provided.",this.template=Handlebars.compile($("#AnswerView-template").html()),this.vent=e.vent||{},_.bindAll(this)},render:function(){return $(this.el).html(this.template({message:this.message})),this},onClickedNext:function(){this.trigger("next")}}),ChooseRightAnswerView=Backbone.View.extend({initialize:function(e){this.vent=e.vent||{},this.template=Handlebars.compile(e.template||""),_.bindAll(this),this.on("clickedCorrectAnswer",this.onCorrectAnswer),this.on("clickedWrongAnswer",this.onWrongAnswer),this.on("render",this.onRender),this.correctAnswerId=1,this.questionList=(new ChooseQuestionListView({collection:this.model.get("questions"),vent:this.vent})).bind("clickedQuestion",this.onClickedQuestion),this.audioPlayer=new SimpleAudioPlayerView({model:new Backbone.Model({url:"http://dev.local:3000/game/recording/1337"})})},render:function(){return console.log("ChooseRightAnswerView:render"),$(this.el).html(this.template({message:"What is Samsan saying?"})),$(this.el).append(this.audioPlayer.render().el),$(this.el).append(this.questionList.render().el),this.trigger("render"),this},renderResponseView:function(){this.answerView.bind("next",this.onNext),$(this.el).append(this.answerView.render().el)},isCorrectAnswer:function(e){return this.correctAnswerId==e.id},onClickedQuestion:function(e){console.log("ChooseRightAnswerView:onClickedQuestion"),this.questionList.off("clickedQuestion",this.onClickedQuestion);var t=this.isCorrectAnswer(e.model),n=t?"btn-success btn-iscorrect":"btn-danger btn-iswrong";$(e.view.el).removeClass("btn-primary"),$(e.view.el).addClass(n),$(e.view.el).addClass("active");var r=t?"clickedCorrectAnswer":"clickedWrongAnswer";this.trigger(r)},onCorrectAnswer:function(){this.answerView=new AnswerView({vent:this.vent,message:"Correct!"}),this.renderResponseView()},onWrongAnswer:function(){this.answerView=new AnswerView({vent:this.vent,message:"Wrong!"}),this.renderResponseView()},onNext:function(){this.trigger("next")}}),PlayingListeningView=Backbone.View.extend({className:"listening",initialize:function(e){this.vent=e.vent||{},this.template=Handlebars.compile(e.template||""),_.bindAll(this),this.activeView=(new ChooseRightAnswerView({el:$(this.el),vent:this.vent,template:$("#ChooseRightAnswerView-template").html(),model:this.model})).bind("next",this.onNext)},render:function(){return this.activeView.render(),this},onNext:function(){this.trigger("next")}}),YourTurnView=Backbone.View.extend({className:"next-turn",initialize:function(e){this.vent=e.vent,this.template=Handlebars.compile(e.template||"")},render:function(){return $(this.el).html(this.template({message:"It's your turn now."})),this}}),PlayingChooseWhatToSay=Backbone.View.extend({tagName:"div",initialize:function(e){this.vent=e.vent||{},this.template=Handlebars.compile(e.template||""),_.bindAll(this),this.clickedQuestionEventName=e.clickedQuestionEventName||"/game/speaking/clickedAnswer",this.questionList=(new ChooseQuestionListView({model:this.model,vent:this.vent,clickedQuestionEventName:this.clickedQuestionEventName})).bind("clickedQuestion",this.onClickedQuestion)},render:function(){return $(this.el).append(this.template({message:"Choose what to say!"})),$(this.el).append(this.questionList.render().el),this},onClickedQuestion:function(e){console.log("PlayingChooseWhatToSay:onClickedQuestion"),this.trigger("clickedQuestion",e)}}),PlayingNextTurnView=Backbone.View.extend({className:"next-turn",initialize:function(e){this.vent=e.vent,this.template=Handlebars.compile(e.template||"")},render:function(){$(this.el).html(this.template({message:"Waiting for other party to reply"}));var e=this;return setTimeout(function(){e.trigger("next")},2e3),this}}),PlayingSpeakingView=Backbone.View.extend({initialize:function(e){this.vent=e.vent||{},this.template=Handlebars.compile(e.template||""),_.bindAll(this),this.on("onload",this.onLoad),this.trigger("onload")},render:function(){return $(this.el).html(this.activeView.render().el),this},onLoad:function(){var e=(new PlayingChooseWhatToSay({vent:this.vent,template:$("#PlayingChooseWhatToSay-template").html(),model:this.model})).bind("clickedQuestion",this.onClickedQuestion);this.activeView=e},onClickedQuestion:function(e){console.log("PlayingSpeakingView:onClickedQuestion"),this.model.save({currentParagraphDefinition:e.model.id});var t=(new RecordTranslationView({vent:this.vent,template:$("#RecordTranslation-template").html(),model:e.model})).bind("successfull",this.onRecordingSent);this.activeView=t,this.render()},onRecordingSent:function(){var e=(new PlayingNextTurnView({vent:this.vent,template:$("#PlayingNextTurnView-template").html()})).bind("next",this.onNextTurnFinished);this.activeView=e,this.render()},onNextTurnFinished:function(){this.trigger("next")}}),RecordTranslationView=Backbone.View.extend({className:"record",initialize:function(e){this.vent=e.vent||{},this.template=Handlebars.compile(e.template||""),this.questionView=new ChooseQuestionView({model:this.model,vent:e.vent}),_.bindAll(this),this.on("/game/#id/recording_succesful",this.success),this.on("/game/#id/recording_failed",this.failed),this.recorder=new SimpleAudioRecorderView({model:new Backbone.Model({recordingUrl:"http://dev.local:3000/game/recording/1337",playingUrl:"http://dev.local:3000/game/recording/1337"})})},events:{"click .btn.btn-record":"record","click .btn.btn-send-recording":"next"},render:function(){return $(this.el).append(this.questionView.render().el),$(this.el).append(this.template({instruction:"Translate to English, and record your translation!"})),$(this.el).append(this.recorder.render().el),this},record:function(){console.log("doing record");var e=this;setTimeout(function(){e.trigger("/game/#id/recording_succesful")},500)},hide:function(){$(this.el).find(".alert.alert-error").hide(),$(this.el).find(".btn.btn-send-recording").hide()},success:function(){$(this.el).find(".alert.alert-error").hide(),$(this.el).find(".btn.btn-send-recording").show()},failed:function(){$(this.el).find(".alert.alert-error").show(),$(this.el).find(".btn.btn-send-recording").hide()},next:function(){this.trigger("successfull")}}),App=function(){var e=function(){var e=new AppRouter;Backbone.history.start()};return{initialize:e}};Backbone.Model.prototype.idAttribute="_id",$(document).ready(function(){App().initialize()});